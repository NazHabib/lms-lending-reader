name: Delete Old Artifacts

on:
  schedule:
    - cron: '0 0 * * 0'   # Sundays at 00:00 UTC
  workflow_dispatch:

# Make sure the GITHUB_TOKEN can delete artifacts
permissions:
  actions: write
  contents: read

concurrency:
  group: delete-old-artifacts
  cancel-in-progress: false

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Delete artifacts older than N days
        uses: actions/github-script@v7
        with:
          script: |
            const DAYS = 7; // change as needed
            const cutoff = new Date(Date.now() - DAYS*24*60*60*1000);

            let page = 1;
            let total = 0, deleted = 0;

            while (true) {
              const res = await github.rest.actions.listArtifactsForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 100,
                page
              });

              const artifacts = res.data.artifacts ?? [];
              if (artifacts.length === 0) break;

              for (const a of artifacts) {
                total++;
                const createdAt = new Date(a.created_at);
                if (createdAt < cutoff) {
                  try {
                    await github.rest.actions.deleteArtifact({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      artifact_id: a.id
                    });
                    core.info(`Deleted artifact ${a.name} (created ${a.created_at})`);
                    deleted++;
                  } catch (err) {
                    core.warning(`Failed to delete ${a.name} (${a.id}): ${err.message}`);
                  }
                }
              }

              page++;
            }

            core.info(`Checked ${total} artifacts; deleted ${deleted}.`);
