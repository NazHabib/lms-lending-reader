name: Deploy application to production

on:
  push:
    branches: [ main ]

permissions:
  contents: read

concurrency:
  group: prod-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # --------------------------- Stage checkout ---------------------------
  checkout:
    name: Stage checkout
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify repository state
        run: |
          git status
          echo "Runner temp dir is: $RUNNER_TEMP"

      # archive source (kept per your structure)
      - name: Create source archive
        run: |
          git archive --format=tar.gz -o source.tar.gz HEAD
          ls -lh source.tar.gz

      - name: Upload source artifact
        uses: actions/upload-artifact@v4
        with:
          name: source
          path: source.tar.gz
          retention-days: 7

  # ----------------------------- Stage build ----------------------------
  build:
    name: Stage build
    runs-on: ubuntu-latest
    needs: checkout
    steps:
      - name: Download source artifact
        uses: actions/download-artifact@v4
        with:
          name: source
          path: .

      - name: Unpack source
        run: tar -xzf source.tar.gz

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Make Maven wrapper executable
        run: chmod +x mvnw

      # FYI: this jar is NOT used for deployment (tests run in 'test' stage)
      - name: Package application (skip tests)
        run: ./mvnw -B -ntp clean package -DskipTests

      - name: Upload app artifact (untested)
        uses: actions/upload-artifact@v4
        with:
          name: app
          path: target/*.jar
          retention-days: 3

  # ------------------------------ Stage test ----------------------------
  test:
    name: Stage test
    runs-on: ubuntu-latest
    needs: checkout
    env:
      NVD_API_KEY: ${{ secrets.NVD_API_KEY }}
    steps:
      - name: Download source artifact
        uses: actions/download-artifact@v4
        with:
          name: source
          path: .

      - name: Unpack source
        run: tar -xzf source.tar.gz

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Assert NVD key is present
        run: |
          if [ -z "${{ secrets.NVD_API_KEY }}" ]; then
            echo "NVD_API_KEY secret is empty or not defined"; exit 1;
          fi

      - name: Make Maven wrapper executable
        run: chmod +x mvnw

      # Unit+IT tests, JaCoCo, OWASP (and any static analysis bound to verify)
      - name: Run verify (tests + coverage + OWASP)
        run: ./mvnw -B -ntp clean verify -Dnvd.api.key="${{ secrets.NVD_API_KEY }}"

      # Upload the tested JAR -> THIS is what deployment will use
      - name: Upload tested app artifact (JAR)
        uses: actions/upload-artifact@v4
        with:
          name: app-tested
          path: target/*.jar
          retention-days: 7

      - name: Upload JaCoCo Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-report
          path: target/site/jacoco
          retention-days: 7

      - name: Upload OWASP report (if present)
        uses: actions/upload-artifact@v4
        with:
          name: owasp-report
          path: |
            target/dependency-check-report.html
            target/dependency-check-report.json
          if-no-files-found: ignore
          retention-days: 7

  # --------------------------- Stage deployment -------------------------
  deployment:
    name: Stage deployment
    runs-on: ubuntu-latest
    needs: [test]           # deploys the TESTED artifact only
    environment:
      name: production      # protect with required reviewers in repo settings
      # url: https://your-prod-url.example.com

    steps:
      - name: Download TESTED app artifact
        uses: actions/download-artifact@v4
        with:
          name: app-tested
          path: ./deploy

      # Replace with your real deployment steps (Docker, SSH, K8s, etc.)
      - name: Echo deploy
        run: |
          echo "Ready to deploy (tested artifact):"
          ls -l ./deploy
