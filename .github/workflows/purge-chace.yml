name: Delete All Caches

on:
  workflow_dispatch:

permissions:
  actions: write
  contents: read

concurrency:
  group: delete-all-caches
  cancel-in-progress: false

jobs:
  delete-caches:
    runs-on: ubuntu-latest
    steps:
      - name: Delete caches
        uses: actions/github-script@v7
        with:
          script: |
            let page = 1;
            let deleted = 0;

            while (true) {
              const res = await github.rest.actions.getActionsCacheList({
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 100,
                page
              });

              const caches = res.data.actions_caches ?? [];
              if (caches.length === 0) break;

              for (const cache of caches) {
                try {
                  await github.rest.actions.deleteActionsCacheById({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    cache_id: cache.id
                  });
                  core.info(`Deleted cache key: ${cache.key} (created ${cache.created_at})`);
                  deleted++;
                } catch (err) {
                  core.warning(`Failed to delete cache ${cache.id}: ${err.message}`);
                }
              }

              page++;
            }

            core.info(`Deleted ${deleted} caches.`);
