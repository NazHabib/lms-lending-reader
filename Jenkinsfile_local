pipeline {

  agent any

  options {
    timestamps()
    disableConcurrentBuilds()
    buildDiscarder(logRotator(numToKeepStr: '20'))
  }

  tools {
    jdk 'jdk-17'
  }

  parameters {
    // Application Configuration
    string(name: 'APP_NAME', defaultValue: 'psoft', description: 'Base name for containers')
    string(name: 'DOCKER_IMAGE', defaultValue: 'nazhabibi/library-management', description: 'Docker Hub repo')
    string(name: 'JAR_NAME', defaultValue: 'psoft-g1-0.0.1-SNAPSHOT.jar', description: 'Built JAR name')
    booleanParam(name: 'PUSH_IMAGE', defaultValue: true, description: 'Push image to Docker Hub?')

    // Deployment Ports
    string(name: 'DEV_PORT', defaultValue: '8082', description: 'Dev HTTP port')
    string(name: 'STAGE_PORT', defaultValue: '8083', description: 'Staging HTTP port')
    string(name: 'PROD_PORT', defaultValue: '8084', description: 'Prod HTTP port')

    // Database Ports
    string(name: 'DEV_DB_PORT', defaultValue: '1521', description: 'Dev H2 DB port')
    string(name: 'STAGE_DB_PORT', defaultValue: '1522', description: 'Stage H2 DB port')
    string(name: 'PROD_DB_PORT', defaultValue: '1523', description: 'Prod H2 DB port')

    // Web Console Ports
    string(name: 'DEV_DB_WEB_PORT', defaultValue: '8085', description: 'Dev H2 Web Console port')
    string(name: 'STAGE_DB_WEB_PORT', defaultValue: '8086', description: 'Stage H2 Web Console port')
    string(name: 'PROD_DB_WEB_PORT', defaultValue: '8087', description: 'Prod H2 Web Console port')

    // Local Deployment Hosts
    string(name: 'DEV_HOST', defaultValue: 'localhost', description: 'Dev SSH host')
    string(name: 'STAGE_HOST', defaultValue: 'localhost', description: 'Stage SSH host')
    string(name: 'PROD_HOST', defaultValue: 'localhost', description: 'Prod SSH host')

    // Database Configuration
    string(name: 'DEV_DB_NAME', defaultValue: 'psoft_dev', description: 'Dev database name')
    string(name: 'STAGE_DB_NAME', defaultValue: 'psoft_stage', description: 'Stage database name')
    string(name: 'PROD_DB_NAME', defaultValue: 'psoft_prod', description: 'Prod database name')

    string(name: 'DB_USER', defaultValue: 'sa', description: 'H2 database username')
    password(name: 'DB_PASSWORD', defaultValue: 'password', description: 'H2 database password')

    // Testing Controls
    booleanParam(name: 'RUN_E2E', defaultValue: false, description: 'Run end-to-end tests?')
    booleanParam(name: 'SKIP_ITS', defaultValue: false, description: 'Skip integration tests?')
    booleanParam(name: 'RUN_MUTATION_TESTS', defaultValue: false, description: 'Run mutation tests (PITest)?')

    // Quality Gates
    string(name: 'UNIT_TEST_THRESHOLD', defaultValue: '80', description: 'Minimum unit test pass rate %')
    string(name: 'COVERAGE_THRESHOLD', defaultValue: '60', description: 'Minimum code coverage %')
  }

  environment {
    COMMIT_SHORT = "${env.GIT_COMMIT?.take(7) ?: 'local'}"
    IMAGE_TAG = "${params.DOCKER_IMAGE}:${env.BUILD_NUMBER}-${COMMIT_SHORT}"

    // Credentials
    GITHUB_CREDS = 'github-odsoft-pat'
    DOCKERHUB_CREDS = 'dockerhub-credentials-id'
    SSH_CREDS = 'jenkins-deploy-key'
    SSH_USER = 'nazmu'

    // Quality Thresholds
    UNIT_TEST_PASS_THRESHOLD = "${params.UNIT_TEST_THRESHOLD}"
    COVERAGE_THRESHOLD = "${params.COVERAGE_THRESHOLD}"
  }

  stages {
    // STAGE 1: Source Code Management & Preparation
    stage('Checkout & Validate') {
      steps {
        checkout([$class: 'GitSCM',
          userRemoteConfigs: [[url: 'https://github.com/BotHeya/ODSOFT.git', credentialsId: env.GITHUB_CREDS]],
          branches: [[name: '*/main']]
        ])

        sh '''
          echo " Library Management System - CI/CD Pipeline"
          echo "Commit: $(git --no-pager log -1 --oneline)"
          echo "Build: ${BUILD_NUMBER}"
        '''

        // Validate project structure
        sh '''
          test -f mvnw && test -d .mvn/wrapper || {
            echo "ERROR: Maven Wrapper not found"
            exit 1
          }
          chmod +x mvnw
          ./mvnw --version
        '''
      }
    }

    // STAGE 2: Dependency Resolution
    stage('Dependency Resolution') {
      steps {
        sh '''
          echo " Resolving dependencies..."
          ./mvnw -B -ntp dependency:resolve dependency:tree
        '''
      }
    }

    // STAGE 3: Static Code Analysis
    stage('Static Analysis') {
      parallel {
        stage('Checkstyle') {
          steps {
            sh """
              ./mvnw -B -ntp checkstyle:checkstyle -Dcheckstyle.failOnViolation=false
            """
          }
          post {
            always {
              publishHTML(target: [
                reportDir: 'target/site',
                reportFiles: 'checkstyle.html',
                reportName: 'Checkstyle Report',
                allowMissing: true,
                alwaysLinkToLastBuild: true,
                keepAll: true
              ])
            }
          }
        }

        stage('PMD') {
          steps {
            sh """
              ./mvnw -B -ntp pmd:pmd -Dpmd.failOnViolation=false
            """
          }
          post {
            always {
              publishHTML(target: [
                reportDir: 'target/site',
                reportFiles: 'pmd.html',
                reportName: 'PMD Report',
                allowMissing: true,
                alwaysLinkToLastBuild: true,
                keepAll: true
              ])
            }
          }
        }

        stage('SpotBugs') {
          steps {
            sh """
              ./mvnw -B -ntp spotbugs:spotbugs -Dspotbugs.failOnError=false
            """
          }
          post {
            always {
              publishHTML(target: [
                reportDir: 'target/site',
                reportFiles: 'spotbugs.html',
                reportName: 'SpotBugs Report',
                allowMissing: true,
                alwaysLinkToLastBuild: true,
                keepAll: true
              ])
            }
          }
        }
      }
    }

    // STAGE 4: Unit Testing & Coverage
    stage('Unit Tests & Coverage') {
      steps {
        sh """
          ./mvnw -B -ntp clean test -DskipITs=true
          ./mvnw -B -ntp jacoco:report
        """
      }
      post {
        always {
          junit testResults: 'target/surefire-reports/**/*.xml', allowEmptyResults: false
          publishHTML(target: [
            reportDir: 'target/site/jacoco',
            reportFiles: 'index.html',
            reportName: 'JaCoCo Coverage Report',
            allowMissing: true,
            alwaysLinkToLastBuild: true,
            keepAll: true
          ])

          // Quality Gate: Unit Test Pass Rate
          script {
            def testResults = junit testResults: 'target/surefire-reports/**/*.xml'
            def totalTests = testResults.totalCount
            def passedTests = totalTests - testResults.failCount - testResults.skipCount
            def passRate = totalTests > 0 ? (passedTests / totalTests * 100) : 0

            env.UNIT_TEST_PASS_RATE = passRate
            echo "Unit Tests: ${passedTests}/${totalTests} (${String.format("%.2f", passRate)}%)"

            if (passRate < env.UNIT_TEST_PASS_THRESHOLD.toFloat()) {
              error " Unit test pass rate below threshold: ${String.format("%.2f", passRate)}% < ${env.UNIT_TEST_PASS_THRESHOLD}%"
            }
          }
        }
      }
    }

    // STAGE 5: Mutation Testing (Optional)
    stage('Mutation Testing') {
      when {
        expression { params.RUN_MUTATION_TESTS }
      }
      steps {
        sh """
          ./mvnw -B -ntp org.pitest:pitest-maven:mutationCoverage -DskipITs=true
        """
      }
      post {
        always {
          publishHTML(target: [
            reportDir: 'target/pit-reports',
            reportFiles: 'index.html',
            reportName: 'Mutation Test Report',
            allowMissing: true,
            alwaysLinkToLastBuild: true,
            keepAll: true
          ])
        }
      }
    }

    // STAGE 6: Integration Testing
    stage('Integration Tests') {
      when {
        expression { !params.SKIP_ITS }
      }
      steps {
        sh """
          ./mvnw -B -ntp -U failsafe:integration-test failsafe:verify
        """
      }
      post {
        always {
          junit testResults: 'target/failsafe-reports/*.xml', allowEmptyResults: true

          script {
            def integrationResults = junit testResults: 'target/failsafe-reports/*.xml', allowEmptyResults: true
            def totalIntegrationTests = integrationResults.totalCount
            if (totalIntegrationTests > 0) {
              def passedIntegrationTests = totalIntegrationTests - integrationResults.failCount
              def integrationPassRate = (passedIntegrationTests / totalIntegrationTests * 100)
              env.INTEGRATION_TEST_PASS_RATE = integrationPassRate
              echo "Integration Tests: ${passedIntegrationTests}/${totalIntegrationTests} (${String.format("%.2f", integrationPassRate)}%)"
            } else {
              env.INTEGRATION_TEST_PASS_RATE = 0
            }
          }
        }
      }
    }

    // STAGE 7: Package Application
    stage('Package Application') {
      steps {
        sh """
          ./mvnw -B -ntp clean package -DskipTests -DskipITs=${params.SKIP_ITS}
          ls -lah target/*.jar
        """
        archiveArtifacts artifacts: 'target/*.jar', fingerprint: true
      }
    }

    // STAGE 8: Docker Image Build
    stage('Build Docker Image') {
      steps {
        script {
          def dockerfileContent = """FROM eclipse-temurin:17-jdk-alpine

# Install sudo and ensure the app user has sudo access
RUN apk add --no-cache sudo && \\
    echo 'app ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers

WORKDIR /app
COPY target/${params.JAR_NAME} app.jar

# Create non-root user and switch to it
RUN adduser -D app && chown -R app:app /app
USER app

# Environment variables for different profiles
ENV SPRING_PROFILES_ACTIVE=dev
ENV SERVER_PORT=${params.DEV_PORT}

EXPOSE ${params.DEV_PORT}
ENTRYPOINT ["java", "-jar", "/app/app.jar"]
"""

          writeFile file: 'Dockerfile', text: dockerfileContent
          sh "docker build -t ${env.IMAGE_TAG} ."

          if (params.PUSH_IMAGE) {
            withCredentials([usernamePassword(credentialsId: env.DOCKERHUB_CREDS, usernameVariable: 'DHU', passwordVariable: 'DHP')]) {
              sh """
                echo \"\$DHP\" | docker login -u \"\$DHU\" --password-stdin
                docker push ${env.IMAGE_TAG}
                docker logout
              """
            }
          }
        }
      }
    }

    // STAGE 9: Quality Gate for Development
    stage('Quality Gate - Development') {
      steps {
        script {
          echo " Development Readiness Assessment"
          echo "Unit Test Pass Rate: ${String.format("%.2f", env.UNIT_TEST_PASS_RATE.toFloat())}%"
          echo "Integration Test Pass Rate: ${String.format("%.2f", env.INTEGRATION_TEST_PASS_RATE.toFloat())}%"

          // Development requires basic quality
          if (env.UNIT_TEST_PASS_RATE.toFloat() < 70) {
            error " Cannot deploy to Development: Unit test quality insufficient"
          }

          echo " Development quality gate passed"
        }
      }
    }

    // STAGE 10: Approve Development Deployment
    stage('Approve Development Deployment') {
      when {
        expression { currentBuild.result != 'FAILURE' }
      }
      steps {
        input message: """ DEPLOY TO DEVELOPMENT - Library Management System

Quality Metrics:
‚úì Unit Tests: ${String.format("%.2f", env.UNIT_TEST_PASS_RATE.toFloat())}% pass rate
‚úì Integration Tests: ${String.format("%.2f", env.INTEGRATION_TEST_PASS_RATE.toFloat())}% pass rate
‚úì Static Analysis: Completed
‚úì Build: Successful

Deployment Target:
Image: ${env.IMAGE_TAG}
Host: ${params.DEV_HOST}
Port: ${params.DEV_PORT}
DB Port: ${params.DEV_DB_PORT}
DB Web Console: ${params.DEV_DB_WEB_PORT}

Confirm development deployment?""",
              ok: 'Deploy to Development',
              submitterParameter: 'DEV_APPROVED_BY'
      }
    }

    stage('Deploy H2 DB - Development') {
      steps {
        sshagent([env.SSH_CREDS]) {
          script {
            sh """
              ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 ${env.SSH_USER}@${params.DEV_HOST} "
                # Stop and remove old H2 container
                docker stop ${params.APP_NAME}-h2-dev || true
                docker rm -f ${params.APP_NAME}-h2-dev || true

                # Run H2 database container with proper configuration
                docker run -d --name ${params.APP_NAME}-h2-dev \\
                  -e H2_OPTIONS='-ifNotExists -baseDir /opt/h2-data' \\
                  -e H2_DATABASE_NAME='library_dev' \\
                  -e H2_USER='${params.DB_USER}' \\
                  -e H2_PASSWORD='${params.DB_PASSWORD}' \\
                  -p ${params.DEV_DB_PORT}:1521 \\
                  -p ${params.DEV_DB_WEB_PORT}:8082 \\
                  -v ${params.APP_NAME}-h2-dev-data:/opt/h2-data \\
                  --restart unless-stopped \\
                  oscarfonts/h2

                # Wait for H2 to start
                sleep 10
                echo ' H2 Database for Development deployed'
              "
            """
          }
        }
      }
    }

    // STAGE 12: Deploy to Development
    stage('Deploy to Development') {
      steps {
        sshagent([env.SSH_CREDS]) {
          script {
            sh """
              ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 ${env.SSH_USER}@${params.DEV_HOST} "
                docker pull ${env.IMAGE_TAG} || true
                docker stop ${params.APP_NAME}-dev || true
                docker rm -f ${params.APP_NAME}-dev || true

                # Use correct JDBC URL format for H2 TCP connection
                docker run -d --name ${params.APP_NAME}-dev \\
                  --link ${params.APP_NAME}-h2-dev:h2-db \\
                  -e SPRING_PROFILES_ACTIVE=dev \\
                  -e SERVER_PORT=${params.DEV_PORT} \\
                  -e SPRING_DATASOURCE_URL='jdbc:h2:tcp://h2-db:1521//opt/h2-data/library_dev;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE' \\
                  -e SPRING_DATASOURCE_USERNAME='${params.DB_USER}' \\
                  -e SPRING_DATASOURCE_PASSWORD='${params.DB_PASSWORD}' \\
                  -e SPRING_DATASOURCE_DRIVER_CLASS_NAME='org.h2.Driver' \\
                  -e SPRING_JPA_HIBERNATE_DDL_AUTO='update' \\
                  -e SPRING_H2_CONSOLE_ENABLED='true' \\
                  -p ${params.DEV_PORT}:${params.DEV_PORT} \\
                  --restart unless-stopped \\
                  ${env.IMAGE_TAG}

                echo ' Development deployment completed'
              "
            """
          }
        }
      }
    }

    // STAGE 13: Functional Testing (Dev)
    stage('Functional Tests - Dev') {
      when {
        expression { params.RUN_E2E }
      }
      steps {
        script {
          timeout(time: 3, unit: 'MINUTES') {
            waitUntil {
              try {
                // Test basic connectivity
                sh "nc -z -w 5 ${params.DEV_HOST} ${params.DEV_PORT}"
                return true
              } catch (Exception e) {
                sleep(time: 10, unit: 'SECONDS')
                return false
              }
            }

            // Test API endpoints
            sh """
              echo " Testing Library Management API endpoints..."
              echo "Service should be available at http://${params.DEV_HOST}:${params.DEV_PORT}"
              echo "H2 Web Console: http://${params.DEV_HOST}:${params.DEV_DB_WEB_PORT}"
            """
          }
        }
      }
    }

    // STAGE 14: Quality Gate for Staging
    stage('Quality Gate - Staging') {
      when {
        expression { currentBuild.result != 'FAILURE' }
      }
      steps {
        script {
          echo " Staging Readiness Assessment"
          echo "Unit Test Pass Rate: ${String.format("%.2f", env.UNIT_TEST_PASS_RATE.toFloat())}%"
          echo "Integration Test Pass Rate: ${String.format("%.2f", env.INTEGRATION_TEST_PASS_RATE.toFloat())}%"

          // Staging requires good test coverage
          if (env.UNIT_TEST_PASS_RATE.toFloat() < 75) {
            error " Cannot deploy to Staging: Unit test coverage insufficient"
          }

          if (env.INTEGRATION_TEST_PASS_RATE.toFloat() < 70 && !params.SKIP_ITS) {
            echo " Warning: Integration test coverage low, but proceeding to approval"
          }

          echo " Staging quality gate passed"
        }
      }
    }

    // STAGE 15: Approve Staging Deployment
    stage('Approve Staging Deployment') {
      when {
        expression { currentBuild.result != 'FAILURE' }
      }
      steps {
        input message: """ DEPLOY TO STAGING - Library Management System

üìä Quality Metrics:
‚úì Unit Tests: ${String.format("%.2f", env.UNIT_TEST_PASS_RATE.toFloat())}% pass rate
‚úì Integration Tests: ${String.format("%.2f", env.INTEGRATION_TEST_PASS_RATE.toFloat())}% pass rate
‚úì Static Analysis: Completed
‚úì Development Tests: ${params.RUN_E2E ? 'PASSED' : 'SKIPPED'}

üéØ Deployment Target:
Image: ${env.IMAGE_TAG}
Host: ${params.STAGE_HOST}
Port: ${params.STAGE_PORT}
DB Port: ${params.STAGE_DB_PORT}
DB Web Console: ${params.STAGE_DB_WEB_PORT}

Confirm staging deployment?""",
              ok: 'Deploy to Staging',
              submitterParameter: 'STAGE_APPROVED_BY'
      }
    }

    // STAGE 16: Deploy H2 Database for Staging
    stage('Deploy H2 DB - Staging') {
      when {
        expression { currentBuild.result != 'FAILURE' }
      }
      steps {
        sshagent([env.SSH_CREDS]) {
          script {
            sh """
              ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 ${env.SSH_USER}@${params.STAGE_HOST} "
                # Create custom network if it doesn't exist
                docker network create library-network 2>/dev/null || true
                
                # Stop and remove old H2 container
                docker stop ${params.APP_NAME}-h2-stage || true
                docker rm -f ${params.APP_NAME}-h2-stage || true

                # Run H2 database container with proper configuration
                docker run -d --name ${params.APP_NAME}-h2-stage \\
                  --network library-network \\
                  -e H2_OPTIONS='-ifNotExists -baseDir /opt/h2-data' \\
                  -e H2_DATABASE_NAME='${params.STAGE_DB_NAME}' \\
                  -e H2_USER='${params.DB_USER}' \\
                  -e H2_PASSWORD='${params.DB_PASSWORD}' \\
                  -p ${params.STAGE_DB_PORT}:1521 \\
                  -p ${params.STAGE_DB_WEB_PORT}:8082 \\
                  -v ${params.APP_NAME}-h2-stage-data:/opt/h2-data \\
                  --restart unless-stopped \\
                  oscarfonts/h2

                # Wait for H2 to start
                sleep 10
                echo ' H2 Database for Staging deployed'
              "
            """
          }
        }
      }
    }

    stage('Deploy to Staging') {
      when {
        expression { currentBuild.result != 'FAILURE' }
      }
      steps {
        sshagent([env.SSH_CREDS]) {
          script {
            sh """
              ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 ${env.SSH_USER}@${params.STAGE_HOST} "
                docker pull ${env.IMAGE_TAG} || true
                docker stop ${params.APP_NAME}-stage || true
                docker rm -f ${params.APP_NAME}-stage || true

                # Run app in same network with correct JDBC URL
                docker run -d --name ${params.APP_NAME}-stage \\
                  --network library-network \\
                  -e SPRING_PROFILES_ACTIVE=test \\
                  -e SERVER_PORT=${params.STAGE_PORT} \\
                  -e SPRING_DATASOURCE_URL='jdbc:h2:tcp://psoft-h2-stage:1521//opt/h2-data/psoft_stage;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE' \\
                  -e SPRING_DATASOURCE_USERNAME='${params.DB_USER}' \\
                  -e SPRING_DATASOURCE_PASSWORD='${params.DB_PASSWORD}' \\
                  -e SPRING_DATASOURCE_DRIVER_CLASS_NAME='org.h2.Driver' \\
                  -e SPRING_JPA_HIBERNATE_DDL_AUTO='update' \\
                  -e SPRING_H2_CONSOLE_ENABLED='true' \\
                  -p ${params.STAGE_PORT}:${params.STAGE_PORT} \\
                  --restart unless-stopped \\
                  ${env.IMAGE_TAG}

                echo ' Staging deployment completed'
              "
            """
          }
        }
      }
    }

    // STAGE 18: System Testing (Staging)
    stage('System Tests - Staging') {
      when {
        expression { params.RUN_E2E }
      }
      steps {
        script {
          timeout(time: 3, unit: 'MINUTES') {
            waitUntil {
              try {
                sh "nc -z -w 5 ${params.STAGE_HOST} ${params.STAGE_PORT}"
                return true
              } catch (Exception e) {
                sleep(time: 10, unit: 'SECONDS')
                return false
              }
            }

            sh """
              echo " Staging environment verified"
              echo "Service running on http://${params.STAGE_HOST}:${params.STAGE_PORT}"
              echo "H2 Web Console: http://${params.STAGE_HOST}:${params.STAGE_DB_WEB_PORT}"
            """
          }
        }
      }
    }

    // STAGE 19: Quality Gate for Production
    stage('Quality Gate - Production') {
      when {
        expression { currentBuild.result != 'FAILURE' }
      }
      steps {
        script {
          echo "üîç Production Readiness Assessment"
          echo "Unit Tests: ${String.format("%.2f", env.UNIT_TEST_PASS_RATE.toFloat())}%"
          echo "Integration Tests: ${String.format("%.2f", env.INTEGRATION_TEST_PASS_RATE.toFloat())}%"

          // Production requires excellent quality
          if (env.UNIT_TEST_PASS_RATE.toFloat() < 80) {
            error " Cannot deploy to Production: Unit test quality insufficient"
          }

          if (env.INTEGRATION_TEST_PASS_RATE.toFloat() < 70 && !params.SKIP_ITS) {
            echo " Warning: Integration test coverage low for production"
          }

          echo " Production quality gate passed"
        }
      }
    }

    // STAGE 20: Approve Production Deployment
    stage('Approve Production Deployment') {
      when {
        expression { currentBuild.result != 'FAILURE' }
      }
      steps {
        input message: """üöÄ DEPLOY TO PRODUCTION - Library Management System

 Quality Metrics:
‚úì Unit Tests: ${String.format("%.2f", env.UNIT_TEST_PASS_RATE.toFloat())}% pass rate
‚úì Integration Tests: ${String.format("%.2f", env.INTEGRATION_TEST_PASS_RATE.toFloat())}% pass rate
‚úì Static Analysis: Completed
‚úì Functional Tests: ${params.RUN_E2E ? 'PASSED' : 'SKIPPED'}
‚úì Staging Tests: ${params.RUN_E2E ? 'PASSED' : 'SKIPPED'}

üéØ Deployment Target:
Image: ${env.IMAGE_TAG}
Host: ${params.PROD_HOST}
Port: ${params.PROD_PORT}
DB Port: ${params.PROD_DB_PORT}
DB Web Console: ${params.PROD_DB_WEB_PORT}

‚ö†Ô∏è  WARNING: This will deploy to PRODUCTION environment

Confirm production deployment?""",
              ok: 'Deploy to Production',
              submitterParameter: 'PROD_APPROVED_BY'
      }
    }

    stage('Deploy H2 DB - Production') {
      when {
        expression { currentBuild.result != 'FAILURE' }
      }
      steps {
        sshagent([env.SSH_CREDS]) {
          script {
            sh """
              ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 ${env.SSH_USER}@${params.PROD_HOST} "
                # Create custom network if it doesn't exist
                docker network create library-network 2>/dev/null || true
                
                # Stop and remove old H2 container
                docker stop ${params.APP_NAME}-h2-prod || true
                docker rm -f ${params.APP_NAME}-h2-prod || true

                # Run H2 database container with proper configuration
                docker run -d --name ${params.APP_NAME}-h2-prod \\
                  --network library-network \\
                  -e H2_OPTIONS='-ifNotExists -baseDir /opt/h2-data' \\
                  -e H2_DATABASE_NAME='${params.PROD_DB_NAME}' \\
                  -e H2_USER='${params.DB_USER}' \\
                  -e H2_PASSWORD='${params.DB_PASSWORD}' \\
                  -p ${params.PROD_DB_PORT}:1521 \\
                  -p ${params.PROD_DB_WEB_PORT}:8082 \\
                  -v ${params.APP_NAME}-h2-prod-data:/opt/h2-data \\
                  --restart unless-stopped \\
                  oscarfonts/h2

                # Wait for H2 to start
                sleep 10
                echo ' H2 Database for Production deployed'
              "
            """
          }
        }
      }
    }

    // STAGE 22: Deploy to Production
    stage('Deploy to Production') {
      when {
        expression { currentBuild.result != 'FAILURE' }
      }
      steps {
        sshagent([env.SSH_CREDS]) {
          script {
            sh """
              ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 ${env.SSH_USER}@${params.PROD_HOST} "
                docker pull ${env.IMAGE_TAG}
                docker stop ${params.APP_NAME}-prod || true
                docker rm -f ${params.APP_NAME}-prod || true

                # Run app in same network with correct JDBC URL
                docker run -d --name ${params.APP_NAME}-prod \\
                  --network library-network \\
                  -e SPRING_PROFILES_ACTIVE=prod \\
                  -e SERVER_PORT=${params.PROD_PORT} \\
                  -e SPRING_DATASOURCE_URL='jdbc:h2:tcp://psoft-h2-prod:1521//opt/h2-data/psoft_prod;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE' \\
                  -e SPRING_DATASOURCE_USERNAME='${params.DB_USER}' \\
                  -e SPRING_DATASOURCE_PASSWORD='${params.DB_PASSWORD}' \\
                  -e SPRING_DATASOURCE_DRIVER_CLASS_NAME='org.h2.Driver' \\
                  -e SPRING_JPA_HIBERNATE_DDL_AUTO='update' \\
                  -e SPRING_H2_CONSOLE_ENABLED='true' \\
                  -p ${params.PROD_PORT}:${params.PROD_PORT} \\
                  --restart unless-stopped \\
                  ${env.IMAGE_TAG}

                echo 'üéâ Production deployment completed successfully!'
              "
            """
          }
        }
      }
    }
    // STAGE 23: Post-Deployment Verification
    stage('Post-Deployment Verification') {
      when {
        expression { params.RUN_E2E && env.PROD_APPROVED_BY } // run only if e2e is enabled AND prod was approved
      }
      steps {
        script {
          timeout(time: 2, unit: 'MINUTES') {
            waitUntil {
              try {
                sh "nc -z -w 5 ${params.PROD_HOST} ${params.PROD_PORT}"
                return true
              } catch (Exception e) {
                sleep(time: 10, unit: 'SECONDS')
                return false
              }
            }
            sh """
              echo " Production deployment verified"
              echo "Library Management System is running on http://${params.PROD_HOST}:${params.PROD_PORT}"
              echo "H2 Web Console: http://${params.PROD_HOST}:${params.PROD_DB_WEB_PORT}"
            """
          }
        }
      }
    }
  }

  post {
    always {
      echo " Pipeline Execution Completed"
      echo "Build: ${env.BUILD_TAG}"
      echo "Image: ${env.IMAGE_TAG}"
      echo "Result: ${currentBuild.result}"

      // Cleanup
      sh "docker rmi ${env.IMAGE_TAG} || true"

      // Final report with approval tracking
      script {
        echo " Final Deployment Report:"
        echo "  - Unit Tests: ${String.format("%.2f", env.UNIT_TEST_PASS_RATE.toFloat())}%"
        echo "  - Integration Tests: ${String.format("%.2f", env.INTEGRATION_TEST_PASS_RATE.toFloat())}%"
        if (env.DEV_APPROVED_BY) {
          echo "  - Development:  Approved by ${env.DEV_APPROVED_BY}"
        }
        if (env.STAGE_APPROVED_BY) {
          echo "  - Staging:  Approved by ${env.STAGE_APPROVED_BY}"
        }
        if (env.PROD_APPROVED_BY) {
          echo "  - Production:  Approved by ${env.PROD_APPROVED_BY}"
        }
        echo "  - Final Status: ${currentBuild.result == 'SUCCESS' ? 'SUCCESSFUL' : 'FAILED'}"
      }
    }

    success {
      script {
        def deployedEnvironments = []
        if (env.DEV_APPROVED_BY) deployedEnvironments.add("Development")
        if (env.STAGE_APPROVED_BY) deployedEnvironments.add("Staging")
        if (env.PROD_APPROVED_BY) deployedEnvironments.add("Production")

        if (deployedEnvironments) {
          echo " Pipeline successful! Deployed to: ${deployedEnvironments.join(', ')}"
        } else {
          echo " Pipeline successful - No deployments approved"
        }
      }
    }

    failure {
      echo " Pipeline failed - Check stage logs for details"
    }

    unstable {
      echo " Pipeline completed with warnings - Code quality issues detected"
    }
  }
}